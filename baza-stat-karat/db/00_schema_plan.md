# План схемы базы данных `baza-stat-karat`

Цель: хранить статистику по заказам столешниц, теоретическим нормам времени и фактическому выполнению заказов в производстве «Карат столешницы».
База будет использоваться:
- калькулятором (теория),
- системой учёта времени (факт),
- отчётами по эффективности мастеров и участков.

## 1. Общие правила по БД

1. СУБД: PostgreSQL (Supabase).
2. Схема: все таблицы в схеме `public`.
3. Идентификаторы:
   - тип по умолчанию — `uuid`,
   - генерируются `gen_random_uuid()` (Supabase это поддерживает).
4. В таблицах, где есть смысл, добавляем поля аудита:
   - `created_at timestamptz default now() not null` — когда запись создана;
   - `updated_at timestamptz default now() not null` — когда последний раз изменена (дальше можно повесить триггер).
5. Внешние ключи (`FOREIGN KEY`) делаем с осмысленным поведением:
   - если подчинённые данные не имеют смысла без родителя — `ON DELETE CASCADE`;
   - если нужны для истории — `ON DELETE RESTRICT` или `SET NULL`.
6. Названия таблиц и полей — **латиницей, snake_case**, без пробелов.

## 2. Перечень таблиц

1. `orders` — заказы и теоретические нормы (итог по заказу).
2. `order_parameters` — детальные параметры заказа (площадь, кромка, вырезы и т.п.).
3. `operations_dictionary` — справочник технологических операций и их нормативов.
4. `order_operations` — перечень операций и норм времени по каждому заказу.
5. `masters` — справочник мастеров.
6. `order_execution` — фактическое выполнение заказов мастерами (кто, когда, сколько по факту).
7. `pauses` — паузы в работе по заказу (простой, ожидание клиента и т.п.).
8. `qualification_history` — история изменений квалификации мастеров.
9. `hourly_rates` — справочник часовых ставок по типам материала.
10. `stone_suppliers` — справочник поставщиков камня (акрил).
11. `stones` — каталог камней с привязкой к поставщику и ставке.

Дальше — подробное ТЗ по каждой таблице.

---

## 3. Таблицы

### 3.1. Таблица `orders` (заказы)

**Назначение:**
Один заказ = один расчёт калькулятором. Здесь храним:
- номер заказа,
- тип калькулятора,
- теоретическое время,
- поправки (доп. работы),
- флаги «обучающие данные / выброс».

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор заказа. `default gen_random_uuid()` |
| `created_at` | timestamptz | да | Когда заказ попал в систему. `default now()` |
| `updated_at` | timestamptz | да | Когда заказ послед раз обновлён. |
| `order_number` | text | да, unique | Номер/код заказа из учётной системы. |
| `calculator_type` | text | да | Тип расчёта: например `'acrylic'`, `'quartz'`, `'windowsill'`. |
| `calculator_version` | text | да | Версия калькулятора (для отслеживания изменений логики). |
| `hourly_rate` | numeric(10,2) | да | Ставка часа мастера, на момент расчёта. |
| `theoretical_time_calc_hours` | numeric(10,2) | да | Теоретическое время по калькулятору (без доп.работ), часы. |
| `additional_work_cost` | numeric(10,2) | нет | Стоимость доп. работ, руб. |
| `additional_work_time_hours` | numeric(10,2) | нет | Время на доп. работы, часы. |
| `theoretical_time_total_hours` | numeric(10,2) | да | Итоговая теория = калькулятор + доп.работы, часы. |
| `complexity_level` | int | нет | Уровень сложности заказа (например 1–5). |
| `is_training_data` | boolean | да | Используем ли заказ для обучения моделей ИИ. `default false` |
| `is_outlier` | boolean | да | Пометка «аномальный заказ» (для фильтрации статистики). `default false` |
| `stone_id` | uuid | нет | Выбранный камень для столешницы. FK → `stones.id` |

**Связи:**
- 1 ко многим с `order_parameters`, `order_operations`, `order_execution`, `pauses`.
- Много к 1 с `stones` (через `stone_id`).

---

### 3.2. Таблица `order_parameters` (параметры заказов)

**Назначение:**
Хранит детальные характеристики заказа, которые влияют на нормы времени.

**Базовая идея:**
В этой таблице до 20–25 полей с параметрами. В документе явно перечислены только ключевые, поэтому сейчас фиксируем их, а остальные параметры будут добавляться отдельно после согласования.

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор строки параметров. |
| `order_id` | uuid | да | Заказ, к которому относятся параметры. FK → `orders.id`, `ON DELETE CASCADE`. |
| `countertop_sqm` | numeric(10,2) | да | Площадь столешницы, м². `default 0` |
| `edge_radius_m` | numeric(10,2) | да | Длина радиусной кромки, пог.м. `default 0` |
| `sink_round_pcs` | int | да | Количество круглых моек. `default 0` |
| `sink_rect_pcs` | int | да | Количество прямоугольных моек. `default 0` |
| `thickness_mm` | int | да | Толщина столешницы, мм. `default 0` |

**Важно:**
В документе указано "Всего параметров: 24". Конкретный список оставшихся полей (фартуки, подоконники, вырезы под варку и т.п.) нужно будет добавить отдельно — после того как утвердите перечень параметров. Сейчас ТЗ фиксирует только структуру и несколько базовых полей.

---

### 3.3. Таблица `operations_dictionary` (справочник операций)

**Назначение:**
Справочник всех технологических операций, которые может выполнять мастер (резка, кромление, склейка, выезд на монтаж и т.п.) с нормативным временем.

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор операции. |
| `code` | text | да, unique | Краткий код операции: `'CUT'`, `'EDGE'`, `'GLUE'` и т.п. |
| `name` | text | да | Человеческое название операции. |
| `description` | text | нет | Подробное описание, чтобы мастер понимал, о чём речь. |
| `default_duration_min` | int | да | Нормативное время операции в минутах. |
| `is_active` | boolean | да | Используется ли операция сейчас. `default true` |

**Использование:**
- Подтягивается в калькулятор,
- Связывается с заказами через `order_operations`.

---

### 3.4. Таблица `order_operations` (операции по заказу)

**Назначение:**
Список всех операций для конкретного заказа с их теоретическим временем.

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Строка операции заказа. |
| `order_id` | uuid | да | FK → `orders.id`, `ON DELETE CASCADE`. |
| `operation_id` | uuid | да | FK → `operations_dictionary.id`. |
| `theoretical_duration_min` | int | да | Теоретическое время операции по норме, мин. |
| `source` | text | да | Откуда взялась операция: `'calculator'`, `'manual'`, `'ai_adjusted'` и т.п. |

**Особенности:**
- В сумме по заказу теоретическое время из этой таблицы должно примерно совпадать с `theoretical_time_total_hours` из `orders`.

---

### 3.5. Таблица `masters` (мастера)

**Назначение:**
Справочник исполнителей (мастеров / бригад).

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор мастера. |
| `created_at` | timestamptz | да | Дата создания карточки. |
| `name` | text | да | ФИО или позывной мастера. |
| `qualification_level` | int | да | Текущий уровень квалификации (шкала определяется отдельно, например 1–5). |
| `hourly_rate` | numeric(10,2) | нет | Ставка мастера, если отличается от базовой. |
| `is_active` | boolean | да | Работает ли мастер сейчас. `default true` |

---

### 3.6. Таблица `order_execution` (факт выполнения заказов)

**Назначение:**
Хранит фактическое выполнение заказов: кто делал, когда начал и закончил, статус.

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор записи. |
| `order_id` | uuid | да | FK → `orders.id`. |
| `master_id` | uuid | да | FK → `masters.id`. |
| `planned_start_at` | timestamptz | нет | Плановая дата/время начала работ. |
| `planned_end_at` | timestamptz | нет | Плановая дата/время окончания. |
| `fact_start_at` | timestamptz | да | Фактический старт. |
| `fact_end_at` | timestamptz | нет | Фактическое завершение (может быть NULL, если ещё в работе). |
| `status` | text | да | Статус: `'planned'`, `'in_progress'`, `'done'`, `'paused'`, `'canceled'`. |
| `comment` | text | нет | Свободный комментарий мастера или начальника. |
| `sla_hours` | numeric(10,2) | нет | Целевой SLA по времени для этого заказа. |

---

### 3.7. Таблица `pauses` (паузы)

**Назначение:**
Фиксация пауз/простоев по заказу (ожидание клиента, нет материала, сломался станок и т.п.).

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор паузы. |
| `order_execution_id` | uuid | да | FK → `order_execution.id`, `ON DELETE CASCADE`. |
| `paused_at` | timestamptz | да | Время начала паузы. |
| `resumed_at` | timestamptz | нет | Время окончания паузы (может быть NULL, если пауза ещё идёт). |
| `reason` | text | да | Причина паузы (человекопонятный текст). |
| `duration_min` | int | нет | Рассчитанная длительность паузы, мин (можно считать в отчётах). |

---

### 3.8. Таблица `qualification_history` (история квалификации мастеров)

**Назначение:**
Позволяет видеть, как менялся уровень мастера во времени.

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор записи истории. |
| `master_id` | uuid | да | FK → `masters.id`, `ON DELETE CASCADE`. |
| `changed_at` | timestamptz | да | Когда изменился уровень. |
| `old_level` | int | да | Старый уровень. |
| `new_level` | int | да | Новый уровень. |
| `reason` | text | нет | Причина изменения (аттестация, испытательный срок, рекламации и т.п.). |
| `initiator` | text | нет | Кто изменил уровень (ФИО руководителя / система). |

---

### 3.9. Таблица `hourly_rates` (справочник часовых ставок)

**Назначение:**
Хранит различные варианты часовых ставок в зависимости от типа материала и сложности работы. Позволяет калькулятору и системе учёта гибко рассчитывать стоимость работ.

**Примеры использования:**
- Базовая ставка для акрила
- Повышенная ставка для сложных заказов
- Ставки для других материалов (кварц, мрамор и т.п.)

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор ставки. |
| `name` | text | да | Краткое название (например, 'acrylic_base', 'acrylic_complex'). |
| `material_type` | text | да | Тип материала (например, 'acrylic', 'quartz'). |
| `description` | text | нет | Подробное описание, когда применяется эта ставка. |
| `rate_value` | numeric(10,2) | да | Значение ставки за час работы, в рублях. |
| `is_default` | boolean | да | Является ли ставка дефолтной для материала. `default false` |
| `created_at` | timestamptz | да | Когда ставка создана. `default now()` |

**Связи:**
- 1 ко многим с `stones` (через `stones.hourly_rate_id`) — камень может ссылаться на свою рекомендуемую ставку.

---

### 3.10. Таблица `stone_suppliers` (поставщики камня)

**Назначение:**
Справочник поставщиков искусственного камня (в основном акрил). Позволяет группировать камни по производителям и отслеживать, с какими поставщиками работает производство.

**Примеры:**
- LG Hi-Macs
- Corian
- Staron
- Tristone

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор поставщика. |
| `name` | text | да, unique | Название поставщика/производителя. |
| `is_active` | boolean | да | Работаете ли сейчас с этим поставщиком. `default true` |
| `created_at` | timestamptz | да | Когда поставщик добавлен в справочник. `default now()` |

**Связи:**
- 1 ко многим с `stones` (через `stones.supplier_id`) — у поставщика может быть много камней.

---

### 3.11. Таблица `stones` (каталог камней)

**Назначение:**
Каталог конкретных камней (декоров, артикулов) для столешниц. Каждый камень привязан к поставщику и имеет рекомендуемую ставку работы.

**Примеры записей:**
- Supplier: LG Hi-Macs, Name: "Almond", Material: acrylic, Complexity: simple
- Supplier: Corian, Name: "Glacier White", Material: acrylic, Complexity: simple
- Supplier: Staron, Name: "Galaxy Blue", Material: acrylic, Complexity: complex (сложный цвет, требует особой обработки)

**Требования по полям:**

| Поле | Тип | Обязат. | Описание |
|------|-----|---------|----------|
| `id` | uuid | PK | Идентификатор камня. |
| `supplier_id` | uuid | да | FK → `stone_suppliers.id`. Какой поставщик производит этот камень. |
| `name` | text | да | Название/артикул камня. |
| `material_type` | text | да | Тип материала (например, 'acrylic', 'quartz'). `default 'acrylic'` |
| `hourly_rate_id` | uuid | нет | FK → `hourly_rates.id`. Рекомендуемая ставка для работы с этим камнем. |
| `complexity_level` | text | нет | Уровень сложности обработки ('simple', 'complex'). |
| `is_active` | boolean | да | Доступен ли камень для заказа сейчас. `default true` |
| `created_at` | timestamptz | да | Когда камень добавлен в каталог. `default now()` |

**Связи:**
- Много к 1 с `stone_suppliers` (через `supplier_id`) — каждый камень принадлежит одному поставщику.
- Много к 1 с `hourly_rates` (через `hourly_rate_id`) — камень может иметь рекомендуемую ставку.
- 1 ко многим с `orders` (через `orders.stone_id`) — камень может использоваться во множестве заказов.

**Как это работает вместе:**
1. Администратор создаёт поставщика в `stone_suppliers` (например, "LG Hi-Macs")
2. Добавляет ставки в `hourly_rates` (например, базовая ставка для акрила = 800 руб/час)
3. Создаёт камни в `stones`, привязывая их к поставщику и ставке
4. При создании заказа в `orders` выбирается конкретный камень через `orders.stone_id`
5. Калькулятор автоматически подхватывает ставку из `stones.hourly_rate_id`

---

## 4. Мини-чек-лист перед написанием SQL

1. Уточнить полный список параметров для `order_parameters` (ожидается 24 поля, в ТЗ сейчас зафиксированы только ключевые).
2. Утвердить шкалу `qualification_level` и список статусов `order_execution.status`.
3. После этого можно писать файл `01_tables.sql` с `CREATE TABLE` на основе этой схемы.
